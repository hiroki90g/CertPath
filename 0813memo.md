# CertPath Phase2実装メモ - Supabase認証システム完全実装

## 🎯 今日やったこと（8/13実装内容）

### Phase2: データベース＋認証システム構築完了
1. **PostgreSQLデータベーステーブル作成**（7テーブル）
2. **Row Level Security (RLS) 設定**（セキュリティポリシー）
3. **Google OAuth認証設定**（Google Console + Supabase）
4. **認証システム実装**（React hooks + Context API）

---

## 🗄️ 1. データベーステーブル作成

### やったこと
```sql
-- 7つのテーブルをPostgreSQLで作成
users              # ユーザー情報（Supabase Auth連携）
certifications     # 資格テンプレート  
projects           # 学習プロジェクト
tasks              # タスク管理
activities         # コミュニティ活動
likes              # いいね機能
user_follows       # フォロー機能
```

### 🔧 設計のポイント
- **UUID主キー**: PostgreSQL標準、セキュアで分散対応
- **外部キー制約**: データ整合性確保（CASCADE削除）
- **Check制約**: データベースレベルでのバリデーション
- **インデックス**: クエリパフォーマンス向上
- **トリガー**: updated_at自動更新

### 実行方法
1. **Supabaseダッシュボード** > **「SQL Editor」**
2. `database-setup.sql`を実行
3. テーブル作成完了を確認

---

## 🔒 2. Row Level Security (RLS) 設定

### やったこと
```sql
-- 全テーブルでRLS有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- セキュリティポリシー設定例
CREATE POLICY "Users can view own profile" ON users
    FOR SELECT
    USING (auth_user_id = auth.uid());
```

### 🔐 セキュリティポリシー概要
- **users**: 自分のプロフィール管理 + 公開プロフィール閲覧
- **projects**: 自分のプロジェクト管理 + 公開プロジェクト閲覧
- **tasks**: 自分のタスク管理 + 公開完了タスク閲覧
- **activities**: 自分の活動管理 + 公開ユーザーの活動閲覧

### ⚠️ 重要なポイント
- **auth.uid()**: Supabase認証のユーザーIDを取得
- **公開データ**: `is_progress_public = true`で制御
- **カスケード削除**: ユーザー削除時に関連データも削除
- **自動ユーザー作成**: 認証時にusersテーブルに自動挿入

---

## 🔐 3. Google OAuth認証設定

### Google Console設定
```bash
1. https://console.cloud.google.com でプロジェクト作成
2. OAuth 2.0 クライアントID作成
3. リダイレクトURI設定:
   https://[project-id].supabase.co/auth/v1/callback
4. クライアントID・シークレット取得
```

### Supabase設定
```bash
1. Authentication > Providers > Google有効化
2. Google のクライアントID・シークレット入力
3. Site URL設定: http://localhost:3000
4. Redirect URLs追加
```

### 🧪 認証テスト
- `/test-auth`ページで動作確認
- Googleログイン → ユーザー情報表示 → ログアウト
- usersテーブルに自動レコード作成確認

---

## ⚛️ 4. React認証システム実装

### ファイル構成
```
src/
├── hooks/
│   └── useAuth.ts              # 認証フック
├── contexts/
│   └── AuthContext.tsx         # 認証コンテキスト
├── components/
│   ├── auth/
│   │   └── ProtectedRoute.tsx  # ルート保護
│   └── layout/
│       └── Header.tsx          # 認証対応ヘッダー
└── app/
    ├── login/
    │   └── page.tsx            # ログインページ
    └── layout.tsx              # AuthProvider追加
```

### 🔄 認証フロー
```typescript
// 1. useAuth フック
const { user, loading, signInWithGoogle, signOut } = useAuth()

// 2. 認証状態管理
supabase.auth.onAuthStateChange((event, session) => {
  setUser(session?.user ? mapUser(session.user) : null)
})

// 3. Google OAuth
await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: { redirectTo: `${window.location.origin}/` }
})
```

---

## 📚 初学者向けSupabase認証解説

### Supabaseとは？
- **BaaS (Backend as a Service)**: サーバー管理不要のバックエンド
- **PostgreSQL**: フルマネージドデータベース
- **Auth**: 認証機能（OAuth、JWT等）
- **RLS**: データベースレベルのセキュリティ

### 認証の仕組み
```mermaid
User → Google OAuth → Supabase Auth → JWT Token → RLS Policy → Database
```

1. **ユーザー**: Googleでログイン
2. **OAuth**: Googleが認証を処理
3. **Supabase**: JWTトークン発行
4. **RLS**: トークンでアクセス制御
5. **Database**: 許可されたデータのみ取得

### JWT (JSON Web Token)
- **ステートレス認証**: サーバーにセッション保存不要
- **自己完結型**: トークンに必要な情報を含む
- **セキュア**: 署名付きで改ざん検知可能

### Row Level Security (RLS)
```sql
-- 例: 自分のデータのみアクセス可能
CREATE POLICY "own_data_only" ON projects
    FOR ALL USING (user_id = auth.uid());
```

---

## 🔧 実装で学んだテクニック

### 1. React Context Pattern
```typescript
// Provider: 認証状態を全コンポーネントで共有
<AuthProvider>
  <App />
</AuthProvider>

// Consumer: どこからでも認証状態にアクセス
const { user } = useAuthContext()
```

### 2. Custom Hooks
```typescript
// ロジック分離: 認証処理をhooksに切り出し
export function useAuth() {
  const [user, setUser] = useState<AuthUser | null>(null)
  // 認証ロジック...
  return { user, signIn, signOut }
}
```

### 3. Protected Routes
```typescript
// 認証が必要なページを保護
<ProtectedRoute>
  <ProjectsPage />
</ProtectedRoute>
```

---

## ⚠️ ハマりやすいポイントと解決法

### 1. 環境変数の扱い
```bash
# ❌ 間違い: サーバー起動中に.env.local変更
# ✅ 正解: 変更後にnpm run dev再起動が必要

# ❌ 間違い: .env.localをGitにコミット
# ✅ 正解: .gitignoreで除外済み
```

### 2. RLSポリシーのデバッグ
```sql
-- ポリシーが効いているか確認
SELECT * FROM projects; -- 自分のデータのみ表示される

-- ポリシーを一時無効化（開発時のみ）
ALTER TABLE projects DISABLE ROW LEVEL SECURITY;
```

### 3. TypeScriptエラー
```typescript
// ❌ 間違い: supabase.supabaseUrl (protected)
// ✅ 正解: process.env.NEXT_PUBLIC_SUPABASE_URL
```

### 4. OAuth リダイレクト設定
```bash
# Google Console設定ミス
❌ http://localhost:3000/auth/callback
✅ https://[project-id].supabase.co/auth/v1/callback

# Supabase設定ミス  
❌ Site URL未設定
✅ http://localhost:3000 (開発時)
```

---

## 🚀 次回に向けて

### Phase 3で実装予定
1. **資格データの初期投入**
2. **プロジェクト作成・管理機能**
3. **タスクCRUD機能**
4. **進捗率計算・ダッシュボード**

### 学習すべきポイント
- **Supabase Client**: データ操作（select, insert, update, delete）
- **React Query/SWR**: データフェッチング最適化
- **フォームハンドリング**: React Hook Form
- **状態管理**: useReducer, Zustand等

---

## 📊 Phase2完了サマリー

### ✅ 実装完了
- PostgreSQL 7テーブル作成
- RLSセキュリティポリシー設定
- Google OAuth認証フロー
- React認証システム（hooks + context）
- ログイン・ログアウトUI
- ルート保護機能

### 🎯 成果
- **セキュア**: RLSによるデータ保護
- **UX良好**: Googleワンクリックログイン  
- **拡張可能**: 認証基盤が整備済み
- **型安全**: TypeScript完全対応

**認証基盤が完成し、Phase3のビジネスロジック実装準備が整いました！**